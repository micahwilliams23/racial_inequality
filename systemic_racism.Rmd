---
title: "Systemic Racism in the United States"
author: "Micah Williams"
date: "6/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.height = 5,
                      fig.width = 9)
library(tidycensus)
library(tidyverse)
library(gganimate)

theme_set(theme_minimal())
```

```{r household_income, message = T}
# message = F to supress messages from get_acs()

# import variable labels from .csv (cleaned from load_variables() table, in .csv for easy access)
var_labels <- read_csv('data/variables_labels.csv',
                       col_types = 'cc') %>%
  mutate(order = row_number())

# get income data for blacks by state from 2018 American Community Survey
acs_income_black <- get_acs(geography = 'state',
                        table = 'B19001B',
                        year = 2018,
                        summary_var = 'B19001B_001',
                        cache_table = T) %>%
  
  # remove 'total' rows, add labels and percentages
  filter(variable != 'B19001B_001') %>%
  mutate(percent = estimate / summary_est * 100) %>%
  left_join(var_labels, by = c('variable' = 'name')) %>%
  mutate(label = reorder(label, order),
         race = 'Black')

# change variable names in labels table to match table for white income
var_labels <- var_labels %>%
  mutate(name = str_replace(name, 'B_', 'A_'))

# get income data for whites by state from 2018 American Community Survey
acs_income_white <- get_acs(geography = 'state',
                        table = 'B19001A',
                        year = 2018,
                        summary_var = 'B19001A_001',
                        cache_table = T) %>%
  
  # remove 'total' rows, add labels and percentages
  filter(variable != 'B19001A_001') %>%
  mutate(percent = estimate / summary_est * 100) %>%
  left_join(var_labels, by = c('variable' = 'name')) %>%
  mutate(label = reorder(label, order),
         race = 'White')

# combine black and white income into single table
us_income <- acs_income_white %>%
  full_join(acs_income_black, by = colnames(acs_income_white))

cali_income <- us_income %>% 
  filter(GEOID == '06')

# calculate summary percentages for income levels ( >$75k, <$50k)
brackets <- us_income %>% 
  mutate(var_ext = as.numeric(str_remove(variable, '[:alnum:]{7}_')),
         inc_level = case_when(var_ext >= 12 ~ '>$75k/yr',
                               var_ext <= 7 ~ '<$35k/yr',
                               TRUE ~ 'ignore')) %>%
  filter(inc_level != 'ignore') %>%
  group_by(inc_level, race) %>%
  nest() %>%
  mutate(total_indiv = map_dbl(data, ~ sum(.$estimate)),
         total_pop = map_dbl(data, ~ sum(unique(.$summary_est))),
         percent = total_indiv / total_pop * 100) %>%
  select(race, inc_level, percent) %>%
  .[c(1,3,2,4),]; brackets
```


```{r income_plot, message = T}
# summarize states to produce nationwide numbers
us_income %>% 
  group_by(label,race) %>%
  summarize(percent = sum(estimate) / sum(summary_est) * 100) %>%
  
  # draw plot, customize with themes and labels
  ggplot(aes(label, percent, fill = race)) +
  geom_col(position = position_dodge(0.6), alpha = 0.8) +
  scale_fill_brewer(palette = 'Paired', direction = -1) +
  scale_y_continuous(labels = paste(seq(0,12,4), '%', sep = '')) +
  theme(axis.text.x = element_text(hjust = 1)) +
  labs(title = 'Household Income by Race in the United States (plus D.C. and Puerto Rico)',
       subtitle = 'Nationwide, black Americans are more likely to be in lower income brackets than white Americans.\nIn total, more than 52% of white Americans make at least $75,000 a year. Only 33% of black Americans\nhave incomes at least that high. More than 45% of black Americans make less than $35,000 a year,\nbut only about 27% of white Americans fall in this category.',
       caption = 'Source: 2018 American Community Survey',
       fill = 'Race',
       y = 'Percent of Race Group in Income Bracket',
       x = 'Household Income in Last 12 Months') +
  
  # flip axes to orient bars horizontally
  coord_flip()

```

```{r clean_labels, include = F, eval = F}

# extract variable labels from list of census variables

# census_10 <- load_variables(2010, 'acs5')

var_labels <- census_10 %>% 
  filter(name %in% income_vars) %>%
  mutate(label = str_remove(label, pattern = 'Estimate!!Total!!'),
         order = row_number()) %>%
  select(-concept)

glimpse(var_labels)

# write_csv(clean_labels, 'data/variables_labels.csv')
```

