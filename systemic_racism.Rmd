---
title: "Systemic Racism in the United States"
author: "Micah Williams"
date: "6/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.height = 5,
                      fig.width = 9)
library(tidycensus)
library(tidyverse)
library(gganimate)

theme_set(theme_minimal())
```

```{r get_acs_table}
# create table of variable labels
get_labels <- function(tbl.id){
  
  # load in full list of ACS variable names
  acs_18 <- load_variables(2018, 'acs5', cache = T)
  
  acs_18 %>% 
    filter(str_starts(name, tbl.id)) %>%
    mutate(label = str_remove(label, '([:alpha:]+!{2}){0,2}'))
}

# a function for grabbing a whole table from 2018 ACS by state
get_acs_table <- function(tbl.id, race, year = 2018, ...){
  
  # get table of labels to join with ACS data
  var_labels <- get_labels(tbl.id)
  
  # get data from ACS
  get_acs(geography = 'state',
                        table = tbl.id,
                        year = year,
                        summary_var = paste(tbl.id, '001', sep='_'),
                        cache_table = T) %>%
  
  # remove 'total' rows, add labels and percentages
  # filter(variable != paste(tbl.id, '001', sep='_')) %>%
  mutate(percent = estimate / summary_est * 100) %>%
  left_join(var_labels,
            by = c('variable' = 'name')) %>%
  mutate(label = as.ordered(label),
         race = race)
}
```

```{r household_income}
# message = F to supress messages from get_acs()

acs_income_black <- get_acs_table('B19001B', 'Black')
acs_income_white <- get_acs_table('B19001A', 'White')

# combine black and white income into single table
us_income <- acs_income_white %>%
  full_join(acs_income_black, by = colnames(acs_income_white))

cali_income <- us_income %>% 
  filter(GEOID == '06')

# calculate summary percentages for income levels ( >$75k, <$50k)
us_income %>% 
  mutate(var_ext = as.numeric(str_remove(variable, '[:alnum:]{7}_')),
         inc_level = case_when(var_ext >= 12 ~ '>$75k/yr',
                               var_ext <= 7 ~ '<$35k/yr',
                               TRUE ~ 'ignore')) %>%
  filter(inc_level != 'ignore') %>%
  group_by(inc_level, race) %>%
  nest() %>%
  mutate(total_indiv = map_dbl(data, ~ sum(.$estimate)),
         total_pop = map_dbl(data, ~ sum(unique(.$summary_est))),
         percent = total_indiv / total_pop * 100) %>%
  select(race, inc_level, percent) %>%
  .[c(1,3,2,4),]
```

```{r income_plot, message = T}

# summarize states to produce nationwide numbers
brackets <- us_income %>% 
  group_by(label,race) %>%
  summarize(percent = sum(estimate) / sum(summary_est) * 100)

# draw plot, customize with themes and labels
ggplot() +
  
  geom_col(aes(label, percent, fill = race),
           position = position_dodge(0.6), alpha = 0.8,
           data = brackets) +
  
  scale_fill_brewer(palette = 'Paired', direction = -1) +
  
  scale_y_continuous(breaks = seq(0,12,4),
                     labels = paste(seq(0,12,4), '%', sep = '')) +
  theme(axis.text.x = element_text()) +
  labs(title = 'Household Income by Race in the United States',
       subtitle = 'Includes data from all 50 states, plus Washington D.C. and Puerto Rico.',
       caption = 'Source: 2018 American Community Survey',
       fill = 'Race',
       y = 'Percent of Race Group in Income Bracket',
       x = 'Household Income in Last 12 Months') +
  
  # flip axes to orient bars horizontally
  coord_flip()

# save plot to files
ggsave('images/household_income.png', height = 5, width = 9, dpi = 'retina', units = 'in')

```

```{r education_data}

# get education data from 2018 ACS
education_white <- get_acs_table('C15002A', 'White')
education_black <- get_acs_table('C15002B', 'Black')

# join black and white tables together
education <- full_join(education_white, education_black, by = colnames(education_white))

# remove obsolete tables
rm(education_black, education_white)

education <- education %>%
  
  # add column for sex and further clean labels to show only education level
  mutate(sex = case_when(str_starts(label, 'Male') ~ 'Male',
                         TRUE ~ 'Female'),
         label = str_remove(label, '[:alpha:]+!{2}')) %>%
  
  # remove incorrect summary_est column and summary rows for each sex and total
  select(-summary_est) %>%
  filter(!label %in% c('Male', 'Female', 'Total')) %>%
  
  # calculate new summary column by state, sex, and race
  group_by(GEOID, sex, race) %>%
  nest() %>%
  mutate(summary_est = map_dbl(data, ~ sum(.$estimate))) %>%
  unnest(data)

us_education <- education %>%
  
  # calculate percentages by education level, race, and sex
  group_by(label, race, sex) %>% 
  nest() %>%
  mutate(percent = map_dbl(data, ~ sum(.$estimate) / sum(.$summary_est) * 100)) %>%
  ungroup() %>%
  
  # add columns for group (ex. 'White Males'), convert education levels to factor
  mutate(group = paste(race, ' ', sex, 's', sep = ''),
         label = as.factor(label))

# relevel labels to match sequence of educational attainment
levels(us_education$label) <- levels(us_education$label)[c(1,4,2,3)]

us_education %>%
  
  # add position column for text labels
  group_by(group) %>%
  arrange(group, desc(label)) %>%
  mutate(position = cumsum(percent) - percent / 2) %>%
  ungroup() %>%
  
  # draw stacked bar plot by group with text labels
  ggplot(aes(group, percent, label, fill = label)) +
  geom_col() +
  geom_text(aes(label = round(percent, 1), y = position)) +
  
  # customize plot with new palette, cleaned labels for axes, title, caption
  scale_fill_brewer(palette = 'BuGn', direction = -1) +
  scale_y_continuous(labels = paste(seq(0,100,25), '%', sep = '')) +
  labs(x = '', y = 'Percentage',
       title = 'Educational Attainment by Race and Sex, Americans 25 and Older',
       subtitle = 'Black men and women are both more likely than their white counterparts to not attain post-secondary education.',
       caption = 'Source: 2018 American Community Survey.\nPercentages are rounded.',
       fill = 'Highest Educational Attainment') +
  
  # remove unnecessary lines on axes
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  
  # flip axes for horizontal plot instead of vertical bars
  coord_flip()

# save plot to files
ggsave('images/education.png', height = 5, width = 9, dpi = 'retina')
```


